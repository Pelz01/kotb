<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>King of the Block | Minimalist</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                        mono: ['Space Grotesk', 'monospace'],
                    },
                    colors: {
                        black: '#050505',
                        offblack: '#0f0f0f',
                        white: '#ffffff',
                        grey: '#888888',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
        }
        /* Minimalist Borders & Inputs */
        .sharp-border {
            border: 1px solid #333;
            transition: border-color 0.2s ease;
        }
        .sharp-border:hover {
            border-color: #666;
        }
        .mono-input {
            background: transparent;
            border-bottom: 1px solid #333;
            border-top: none;
            border-left: none;
            border-right: none;
            border-radius: 0;
            color: white;
            transition: all 0.3s ease;
        }
        .mono-input:focus {
            outline: none;
            border-bottom-color: #fff;
        }
        /* Brutalist Button */
        .btn-mono {
            background: white;
            color: black;
            border: 1px solid white;
            transition: all 0.2s ease;
        }
        .btn-mono:hover:not(:disabled) {
            background: black;
            color: white;
        }
        .btn-mono:active:not(:disabled) {
            transform: scale(0.98);
        }
        .btn-mono:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Custom Toast */
        .toast {
            position: fixed;
            top: 24px;
            right: -100%;
            transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 50;
            background: #000;
            border: 1px solid #333;
            max-width: 90vw;
            width: 400px;
        }
        .toast.show {
            right: 24px;
        }
        @media (max-width: 640px) {
            .toast.show {
                right: 5vw;
            }
        }
        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 2px solid black;
            /* Invert for white button */
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        .btn-mono:hover .spinner {
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: white;
        }
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        /* Utility */
        .tracking-tightest {
            letter-spacing: -0.05em;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col antialiased selection:bg-white selection:text-black">
    <!-- Toast Notification -->
    <div id="toast" class="toast px-6 py-4 flex items-center gap-4 min-w-[300px]">
        <div id="toast-indicator" class="w-2 h-2 bg-white rounded-full"></div>
        <div>
            <h4 id="toast-title" class="font-mono text-xs uppercase tracking-widest text-grey">Notification</h4>
            <p id="toast-msg" class="text-sm font-medium mt-1">Message goes here</p>
        </div>
    </div>
    <!-- Navbar -->
    <nav class="w-full max-w-7xl mx-auto px-6 py-8 flex justify-between items-center z-10">
        <div class="flex items-center gap-3">
            <div class="w-6 h-6 border border-white flex items-center justify-center">
                <div class="w-2 h-2 bg-white"></div>
            </div>
            <span class="font-mono font-bold text-lg tracking-tightest uppercase">KingOfTheBlock</span>
        </div>
        <button id="connectBtn"
            class="px-6 py-2 border border-white/20 hover:border-white transition-colors text-xs font-mono uppercase tracking-widest flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-red-500" id="walletStatusDot"></span>
            <span id="connectBtnText">Connect Wallet</span>
        </button>
    </nav>
    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-center w-full max-w-5xl mx-auto px-6">
        <!-- Hero Message -->
        <div class="w-full text-center mb-12 md:mb-20">
            <div class="mb-6 flex justify-center">
                <div class="border border-white/20 px-4 py-1 rounded-full inline-flex items-center gap-2">
                    <span class="text-[10px] uppercase tracking-[0.2em] text-grey">Current Ruler</span>
                    <span id="currentKingAddress" class="font-mono text-xs">0x0000...0000</span>
                </div>
            </div>
            <h1 id="heroMessage"
                class="text-4xl md:text-6xl lg:text-8xl font-bold tracking-tighter leading-none mb-8 break-words max-w-4xl mx-auto px-2">
                The Block is Empty
            </h1>
        </div>
        <!-- Action Area -->
        <div class="w-full max-w-xl">
            <div class="grid grid-cols-2 gap-px bg-white/10 border border-white/10 mb-8">
                <div class="bg-black p-4 md:p-6">
                    <p class="text-[10px] uppercase tracking-widest text-grey mb-1">Current Price</p>
                    <p id="currentPriceDisplay" class="text-xl md:text-2xl font-mono">0.001 ETH</p>
                </div>
                <div class="bg-black p-4 md:p-6">
                    <p class="text-[10px] uppercase tracking-widest text-grey mb-1">Min Bid (+5%)</p>
                    <p id="nextMinBidDisplay" class="text-xl md:text-2xl font-mono text-white">0.0011</p>
                </div>
            </div>
            <!-- Progress Line -->
            <div class="w-full h-px bg-white/10 mb-12 relative">
                <div id="priceBar" class="absolute left-0 top-0 h-full bg-white transition-all duration-1000 w-0"></div>
            </div>
            <!-- Form -->
            <div class="space-y-8">
                <div class="space-y-6">
                    <!-- Message and Bid Inputs -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2 relative">
                            <input type="text" id="messageInput" maxlength="50" placeholder=" "
                                class="mono-input w-full py-4 text-lg md:text-xl peer placeholder-transparent">
                            <label
                                class="absolute left-0 top-4 text-grey text-lg md:text-xl transition-all peer-focus:-top-4 peer-focus:text-xs peer-focus:text-white peer-not-placeholder-shown:-top-4 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:text-white pointer-events-none font-mono">
                                ENTER YOUR PROCLAMATION
                            </label>
                        </div>
                        <div class="relative">
                            <input type="number" id="bidInput" step="0.0001" placeholder=" "
                                class="mono-input w-full py-4 text-lg md:text-xl peer placeholder-transparent font-mono text-cyan-400">
                            <label
                                class="absolute left-0 top-4 text-grey text-lg md:text-xl transition-all peer-focus:-top-4 peer-focus:text-xs peer-focus:text-cyan-400 peer-not-placeholder-shown:-top-4 peer-not-placeholder-shown:text-xs peer-not-placeholder-shown:text-cyan-400 pointer-events-none font-mono">
                                BID (ETH)
                            </label>
                        </div>
                    </div>
                    <button id="claimBtn"
                        class="btn-mono w-full py-5 text-xs md:text-sm font-mono uppercase tracking-[0.2em] font-bold flex items-center justify-center gap-3">
                        <span id="btnText">Claim Throne</span>
                        <div id="btnSpinner" class="spinner hidden"></div>
                    </button>
                    <p id="networkError"
                        class="text-red-500 font-mono text-xs text-center hidden mt-4 border border-red-900 p-2">
                        ⚠ SWITCH TO SEPOLIA NETWORK
                    </p>
                </div>
            </div>
    </main>
    <footer class="w-full py-8 border-t border-white/5 mt-auto">
        <div
            class="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center md:items-end gap-4 text-[10px] text-grey uppercase tracking-widest">
            <p>King of the Block &copy; 2025</p>
            <p>Built with love by <a href="https://twitter.com/pelz0x" target="_blank"
                    class="text-white hover:text-white/80 transition-colors font-bold border-b border-white/20 hover:border-white pb-0.5">Pelz0x</a>
            </p>
        </div>
    </footer>
    <!-- JS Logic -->
    <script>
        // --- CONSTANTS ---
        const CONTRACT_ADDRESS = "0x9bD587253963B1C287C50C2260C7e00d8D28A8DE";
        const SEPOLIA_CHAIN_ID = 11155111;
        const SEPOLIA_HEX = "0xaa36a7";
        // Minimal ABI
        const ABI = [
            "function currentPrice() view returns (uint256)",
            "function currentMessage() view returns (string)",
            "function currentKing() view returns (address)",
            "function claimThrone(string memory _message) payable",
            "event ThroneClaimed(address indexed user, uint256 amount, string note)"
        ];
        // --- STATE ---
        let provider, signer, contract;
        let userAddress = null;
        let currentPriceVal = ethers.BigNumber.from(0);
        // --- DOM ELEMENTS ---
        const connectBtn = document.getElementById('connectBtn');
        const connectBtnText = document.getElementById('connectBtnText');
        const walletStatusDot = document.getElementById('walletStatusDot');
        const heroMessage = document.getElementById('heroMessage');
        const currentKingDisplay = document.getElementById('currentKingAddress');
        const currentPriceDisplay = document.getElementById('currentPriceDisplay');
        const nextMinBidDisplay = document.getElementById('nextMinBidDisplay');
        const priceBar = document.getElementById('priceBar');
        const messageInput = document.getElementById('messageInput');
        const bidInput = document.getElementById('bidInput');
        const claimBtn = document.getElementById('claimBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const networkError = document.getElementById('networkError');
        // --- INIT ---
        window.addEventListener('load', async () => {
            // Check for wallet
            if (typeof window.ethereum !== 'undefined') {
                provider = new ethers.providers.Web3Provider(window.ethereum, "any");
                // Auto-connect if trusted
                try {
                    const accounts = await provider.listAccounts();
                    if (accounts.length > 0) {
                        handleAccountsChanged(accounts);
                    }
                } catch (err) {
                    console.warn("Auto-connect failed", err);
                }
                // Listeners
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', () => window.location.reload());
                // Read-only contract init (if not already set by handleAccountsChanged)
                if (!contract) {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                    fetchContractState().catch(e => console.log("Read-only fetch failed", e));
                }
                // Polling to keep UI in sync (fixes potential RPC lag or missed events)
                setInterval(fetchContractState, 5000);
            } else {
                connectBtnText.innerText = "Install Wallet";
                connectBtn.onclick = () => window.open("https://metamask.io/download/", "_blank");
            }
        });
        // --- CONNECT WALLET ---
        connectBtn.addEventListener('click', async () => {
            if (typeof window.ethereum === 'undefined') {
                window.open("https://metamask.io/download/", "_blank");
                return;
            }
            // If connected, show logout option
            if (userAddress) {
                const shouldLogout = confirm("Disconnect wallet?");
                if (shouldLogout) {
                    // Reset state
                    userAddress = null;
                    signer = null;
                    if (contract) contract.removeAllListeners("ThroneClaimed");
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                    // Update UI
                    connectBtnText.innerText = "Connect Wallet";
                    walletStatusDot.classList.remove('bg-green-500');
                    walletStatusDot.classList.add('bg-red-500');
                    showToast("Disconnected", "Wallet disconnected");
                }
                return;
            }
            try {
                // Request accounts
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                handleAccountsChanged(accounts);
            } catch (err) {
                console.error(err);
                if (err.code === 4001) {
                    showToast("Cancelled", "User rejected connection request");
                } else {
                    showToast("Error", "Connection failed");
                }
            }
        });
        async function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                console.warn("Please connect to MetaMask.");
                userAddress = null;
                connectBtnText.innerText = "Connect Wallet";
                walletStatusDot.classList.remove('bg-green-500');
                walletStatusDot.classList.add('bg-red-500');
            } else {
                userAddress = accounts[0];
                signer = provider.getSigner();
                const shortAddr = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);
                connectBtnText.innerText = shortAddr;
                walletStatusDot.classList.remove('bg-red-500');
                walletStatusDot.classList.add('bg-green-500');
                // Re-init contract with signer
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                // Setup Events
                contract.removeAllListeners("ThroneClaimed"); // Prevent duplicates
                contract.on("ThroneClaimed", (user, amount, note) => {
                    showToast("New Ruler", `King: ${truncateAddress(user)}`);
                    fetchContractState();
                });
                // Check Network
                checkNetwork();
                fetchContractState();
            }
        }
        async function checkNetwork() {
            const network = await provider.getNetwork();
            if (network.chainId !== SEPOLIA_CHAIN_ID) {
                networkError.classList.remove('hidden');
                networkError.innerHTML = `<button onclick="switchNetwork()" class="underline hover:text-red-300">⚠ WRONG NETWORK. CLICK TO SWITCH TO SEPOLIA.</button>`;
            } else {
                networkError.classList.add('hidden');
            }
        }
        window.switchNetwork = async () => {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_HEX }],
                });
            } catch (switchError) {
                // This error code indicates that the chain has not been added to MetaMask.
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: SEPOLIA_HEX,
                                    chainName: 'Sepolia',
                                    rpcUrls: ['https://rpc.sepolia.org'],
                                    nativeCurrency: { name: "Sepolia Ether", symbol: "SEP", decimals: 18 },
                                    blockExplorerUrls: ["https://sepolia.etherscan.io/"]
                                },
                            ],
                        });
                    } catch (addError) {
                        showToast("Error", "Could not add Sepolia network");
                    }
                } else {
                    showToast("Error", "Failed to switch network");
                }
            }
        }
        async function fetchContractState() {
            if (!provider) return;
            try {
                // Use signer if available, else provider
                const contractReader = signer ? contract : new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);
                const price = await contractReader.currentPrice();
                const msg = await contractReader.currentMessage();
                const king = await contractReader.currentKing();
                currentPriceVal = price;
                heroMessage.innerText = msg;
                currentKingDisplay.innerText = truncateAddress(king);
                const ethPrice = ethers.utils.formatEther(price);
                currentPriceDisplay.innerText = (+ethPrice).toFixed(4) + " ETH";
                const minBid = price.mul(105).div(100);
                const ethMinBid = ethers.utils.formatEther(minBid);
                nextMinBidDisplay.innerText = (+ethMinBid).toFixed(4);
                // Auto-fill bid input if empty
                if (!bidInput.value) {
                    bidInput.value = (+ethMinBid).toFixed(5);
                }
                // Animate bar
                priceBar.style.width = (Math.random() * 50 + 40) + '%';
            } catch (err) {
                console.error("Error fetching state:", err);
                // Show error on first fetch attempt (helps debugging)
                if (!currentPriceVal || currentPriceVal.isZero()) {
                    showToast("Error", "Failed to load contract data. Check console.");
                }
            }
        }
        // --- CLAIM ACTION ---
        claimBtn.addEventListener('click', async () => {
            if (!userAddress) {
                // Try connecting
                connectBtn.click();
                return;
            }
            const msg = messageInput.value;
            if (!msg) {
                showToast("Input", "Enter a message");
                return;
            }
            const bidVal = bidInput.value;
            if (!bidVal) {
                showToast("Input", "Enter bid amount");
                return;
            }
            // Final Network Check
            const network = await provider.getNetwork();
            if (network.chainId !== SEPOLIA_CHAIN_ID) {
                switchNetwork();
                return;
            }
            setLoading(true);
            try {
                const bidAmount = ethers.utils.parseEther(bidVal);
                const tx = await contract.claimThrone(msg, { value: bidAmount });
                showToast("Mining", "Transaction broadcast...");
                await tx.wait();
                showToast("Success", "Hail the new King!");
                messageInput.value = "";
                fetchContractState();
            } catch (err) {
                console.error(err);
                let reason = "Transaction failed";
                if (err.code === 'ACTION_REJECTED' || err.code === 4001) reason = "User rejected";
                else if (err.error && err.error.message) reason = "Error: " + err.error.message;
                else if (err.message) reason = err.message.slice(0, 30) + "...";
                showToast("Error", reason);
            } finally {
                setLoading(false);
            }
        });
        // --- UTILS ---
        function truncateAddress(addr) {
            if (!addr || addr === ethers.constants.AddressZero) return "0x000...0000";
            return addr.slice(0, 6) + "..." + addr.slice(-4);
        }
        function setLoading(isLoading) {
            if (isLoading) {
                btnText.classList.add('hidden');
                btnSpinner.classList.remove('hidden');
                claimBtn.disabled = true;
            } else {
                btnText.classList.remove('hidden');
                btnSpinner.classList.add('hidden');
                claimBtn.disabled = false;
            }
        }
        function showToast(title, msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-title').innerText = title;
            // Truncate long error messages to prevent full screen takeover
            if (msg.length > 120) {
                msg = msg.slice(0, 117) + "...";
            }
            document.getElementById('toast-msg').innerText = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>
